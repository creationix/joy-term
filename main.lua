-- "gamepad" module works much better with jit off.
local jit = require('jit')
jit.off()
local G = require('gamepad')

local ffi = require('ffi')
local tb = require('termbox')
local uv = require('uv')

local uni = ffi.new("uint32_t[1]")
local function write(string, x, y, fg, bg)
  local i, l = 1, #string
  while i <= l do
    i = i + tb.tb_utf8_char_to_unicode(uni, string:sub(i))
    tb.tb_change_cell(x, y, uni[0], fg, bg)
    x = x + 1
  end
end

G.Gamepad_init()
local axes = {0,0,0,0,0,0}
G.Gamepad_axisMoveFunc(function (_, axis, value)
  axes[axis + 1] = value
end, nil)

â–‘â–‘â–‘â–„â–„â–ˆâ–€â–€â–€â–€â–€â–€â–€â–€â–ˆâ–„â–„â–‘â–‘â–‘
â–‘â–‘â–ˆâ–€â–‘â–„â–„â–ˆâ–€â–€â–€â–€â–ˆâ–„â–„â–‘â–€â–ˆâ–‘â–‘
â–‘â–‘â–ˆâ–‘â–‘â–ˆâ–„â–„â–€â–€â–€â–€â–„â–„â–ˆâ–‘â–‘â–ˆâ–‘â–‘
â–‘â–‘â–€â–ˆâ–„â–„â–‘â–€â–€â–€â–€â–€â–€â–‘â–„â–„â–ˆâ–€â–‘â–‘
â–‘â–‘â–‘â–„â–„â–€â–€â–€â–ˆâ–€â–€â–ˆâ–€â–€â–€â–„â–„â–‘â–‘â–‘
â–‘â–‘â–ˆâ–‘â–„â–€â–€â–„â–ˆâ–‘â–‘â–ˆâ–„â–€â–€â–„â–‘â–ˆâ–‘â–‘
â–‘â–‘â–€â–„â–‘â–€â–„â–‘â–ˆâ–‘â–‘â–ˆâ–‘â–„â–€â–‘â–„â–€â–‘â–‘
â–‘â–‘â–‘â–‘â–€â–€â–„â–ˆâ–„â–„â–„â–„â–ˆâ–„â–€â–€â–‘â–‘â–‘â–‘

U+270x      âœ   âœ‚   âœƒ   âœ„   âœ…   âœ†   âœ‡   âœˆ   âœ‰   âœŠ   âœ‹   âœŒ   âœ   âœŽ   âœ
U+271x  âœ   âœ‘   âœ’   âœ“   âœ”   âœ•   âœ–   âœ—   âœ˜   âœ™   âœš   âœ›   âœœ   âœ   âœž   âœŸ
U+272x  âœ    âœ¡   âœ¢   âœ£   âœ¤   âœ¥   âœ¦   âœ§   âœ¨   âœ©   âœª   âœ«   âœ¬   âœ­   âœ®   âœ¯
U+273x  âœ°   âœ±   âœ²   âœ³   âœ´   âœµ   âœ¶   âœ·   âœ¸   âœ¹   âœº   âœ»   âœ¼   âœ½   âœ¾   âœ¿
U+274x  â€   â   â‚   âƒ   â„   â…   â†   â‡   âˆ   â‰   âŠ   â‹   âŒ   â   âŽ   â
U+275x  â   â‘   â’   â“   â”   â•   â–   â—   â˜   â™   âš   â›   âœ   â   âž   âŸ
U+276x  â    â¡   â¢   â£   â¤   â¥   â¦   â§   â¨   â©   âª   â«   â¬   â­   â®   â¯
U+277x  â°   â±   â²   â³   â´   âµ   â¶   â·   â¸   â¹   âº   â»   â¼   â½   â¾   â¿
U+278x  âž€   âž   âž‚   âžƒ   âž„   âž…   âž†   âž‡   âžˆ   âž‰   âžŠ   âž‹   âžŒ   âž   âžŽ   âž
U+279x  âž   âž‘   âž’   âž“   âž”   âž•   âž–   âž—   âž˜   âž™   âžš   âž›   âžœ   âž   âžž   âžŸ
U+27Ax  âž    âž¡   âž¢   âž£   âž¤   âž¥   âž¦   âž§   âž¨   âž©   âžª   âž«   âž¬   âž­   âž®   âž¯
U+27Bx  âž°   âž±   âž²   âž³   âž´   âžµ   âž¶   âž·   âž¸   âž¹   âžº   âž»   âž¼   âž½   âž¾   âž¿

U+250x  â”€   â”   â”‚   â”ƒ   â”„   â”…   â”†   â”‡   â”ˆ   â”‰   â”Š   â”‹   â”Œ   â”   â”Ž   â”
U+251x  â”   â”‘   â”’   â”“   â””   â”•   â”–   â”—   â”˜   â”™   â”š   â”›   â”œ   â”   â”ž   â”Ÿ
U+252x  â”    â”¡   â”¢   â”£   â”¤   â”¥   â”¦   â”§   â”¨   â”©   â”ª   â”«   â”¬   â”­   â”®   â”¯
U+253x  â”°   â”±   â”²   â”³   â”´   â”µ   â”¶   â”·   â”¸   â”¹   â”º   â”»   â”¼   â”½   â”¾   â”¿
U+254x  â•€   â•   â•‚   â•ƒ   â•„   â•…   â•†   â•‡   â•ˆ   â•‰   â•Š   â•‹   â•Œ   â•   â•Ž   â•
U+255x  â•   â•‘   â•’   â•“   â•”   â••   â•–   â•—   â•˜   â•™   â•š   â•›   â•œ   â•   â•ž   â•Ÿ
U+256x  â•    â•¡   â•¢   â•£   â•¤   â•¥   â•¦   â•§   â•¨   â•©   â•ª   â•«   â•¬   â•­   â•®   â•¯
U+257x  â•°   â•±   â•²   â•³   â•´   â•µ   â•¶   â•·   â•¸   â•¹   â•º   â•»   â•¼   â•½   â•¾   â•¿

U+258x  â–€   â–   â–‚   â–ƒ   â–„   â–…   â–†   â–‡   â–ˆ   â–‰   â–Š   â–‹   â–Œ   â–   â–Ž   â–
U+259x  â–   â–‘   â–’   â–“   â–”   â–•   â––   â–—   â–˜   â–™   â–š   â–›   â–œ   â–   â–ž   â–Ÿ

U+25Ax  â–    â–¡   â–¢   â–£   â–¤   â–¥   â–¦   â–§   â–¨   â–©   â–ª   â–«   â–¬   â–­   â–®   â–¯
U+25Bx  â–°   â–±   â–²   â–³   â–´   â–µ   â–¶   â–·   â–¸   â–¹   â–º   â–»   â–¼   â–½   â–¾   â–¿
U+25Cx  â—€   â—   â—‚   â—ƒ   â—„   â—…   â—†   â—‡   â—ˆ   â—‰   â—Š   â—‹   â—Œ   â—   â—Ž   â—
U+25Dx  â—   â—‘   â—’   â—“   â—”   â—•   â—–   â——   â—˜   â—™   â—š   â—›   â—œ   â—   â—ž   â—Ÿ
U+25Ex  â—    â—¡   â—¢   â—£   â—¤   â—¥   â—¦   â—§   â—¨   â—©   â—ª   â—«   â—¬   â—­   â—®   â—¯
U+25Fx  â—°   â—±   â—²   â—³   â—´   â—µ   â—¶   â—·   â—¸   â—¹   â—º   â—»   â—¼   â—½   â—¾   â—¿

U+219x  â†   â†‘   â†’   â†“   â†”   â†•   â†–   â†—   â†˜   â†™   â†š   â†›   â†œ   â†   â†ž   â†Ÿ
U+21Ax  â†    â†¡   â†¢   â†£   â†¤   â†¥   â†¦   â†§   â†¨   â†©   â†ª   â†«   â†¬   â†­   â†®   â†¯
U+21Bx  â†°   â†±   â†²   â†³   â†´   â†µ   â†¶   â†·   â†¸   â†¹   â†º   â†»   â†¼   â†½   â†¾   â†¿
U+21Cx  â‡€   â‡   â‡‚   â‡ƒ   â‡„   â‡…   â‡†   â‡‡   â‡ˆ   â‡‰   â‡Š   â‡‹   â‡Œ   â‡   â‡Ž   â‡
U+21Dx  â‡   â‡‘   â‡’   â‡“   â‡”   â‡•   â‡–   â‡—   â‡˜   â‡™   â‡š   â‡›   â‡œ   â‡   â‡ž   â‡Ÿ
U+21Ex  â‡    â‡¡   â‡¢   â‡£   â‡¤   â‡¥   â‡¦   â‡§   â‡¨   â‡©   â‡ª   â‡«   â‡¬   â‡­   â‡®   â‡¯
U+21Fx  â‡°   â‡±   â‡²   â‡³   â‡´   â‡µ   â‡¶   â‡·   â‡¸   â‡¹   â‡º   â‡»   â‡¼   â‡½   â‡¾   â‡¿

U+27Cx  âŸ€   âŸ   âŸ‚   âŸƒ   âŸ„   âŸ…   âŸ†   âŸ‡   âŸˆ   âŸ‰   âŸŠ   âŸ‹   âŸŒ   âŸ   âŸŽ   âŸ
U+27Dx  âŸ   âŸ‘   âŸ’   âŸ“   âŸ”   âŸ•   âŸ–   âŸ—   âŸ˜   âŸ™   âŸš   âŸ›   âŸœ   âŸ   âŸž   âŸŸ
U+27Ex  âŸ    âŸ¡   âŸ¢   âŸ£   âŸ¤   âŸ¥   âŸ¦   âŸ§   âŸ¨   âŸ©   âŸª   âŸ«   âŸ¬   âŸ­   âŸ®   âŸ¯

U+2B0x  â¬€   â¬   â¬‚   â¬ƒ   â¬„   â¬…   â¬†   â¬‡   â¬ˆ   â¬‰   â¬Š   â¬‹   â¬Œ   â¬   â¬Ž   â¬
U+2B1x  â¬   â¬‘   â¬’   â¬“   â¬”   â¬•   â¬–   â¬—   â¬˜   â¬™   â¬š   â¬›   â¬œ   â¬   â¬ž   â¬Ÿ
U+2B2x  â¬    â¬¡   â¬¢   â¬£   â¬¤   â¬¥   â¬¦   â¬§   â¬¨   â¬©   â¬ª   â¬«   â¬¬   â¬­   â¬®   â¬¯
U+2B3x  â¬°   â¬±   â¬²   â¬³   â¬´   â¬µ   â¬¶   â¬·   â¬¸   â¬¹   â¬º   â¬»   â¬¼   â¬½   â¬¾   â¬¿
U+2B4x  â­€   â­   â­‚   â­ƒ   â­„   â­…   â­†   â­‡   â­ˆ   â­‰   â­Š   â­‹   â­Œ
U+2B5x  â­   â­‘   â­’   â­“   â­”   â­•   â­–   â­—   â­˜   â­™

U+1F70x   ðŸœ€   ðŸœ   ðŸœ‚   ðŸœƒ   ðŸœ„   ðŸœ…   ðŸœ†   ðŸœ‡   ðŸœˆ   ðŸœ‰   ðŸœŠ   ðŸœ‹   ðŸœŒ   ðŸœ   ðŸœŽ   ðŸœ
U+1F71x   ðŸœ   ðŸœ‘   ðŸœ’   ðŸœ“   ðŸœ”   ðŸœ•   ðŸœ–   ðŸœ—   ðŸœ˜   ðŸœ™   ðŸœš   ðŸœ›   ðŸœœ   ðŸœ   ðŸœž   ðŸœŸ
U+1F72x   ðŸœ    ðŸœ¡   ðŸœ¢   ðŸœ£   ðŸœ¤   ðŸœ¥   ðŸœ¦   ðŸœ§   ðŸœ¨   ðŸœ©   ðŸœª   ðŸœ«   ðŸœ¬   ðŸœ­   ðŸœ®   ðŸœ¯
U+1F73x   ðŸœ°   ðŸœ±   ðŸœ²   ðŸœ³   ðŸœ´   ðŸœµ   ðŸœ¶   ðŸœ·   ðŸœ¸   ðŸœ¹   ðŸœº   ðŸœ»   ðŸœ¼   ðŸœ½   ðŸœ¾   ðŸœ¿
U+1F74x   ðŸ€   ðŸ   ðŸ‚   ðŸƒ   ðŸ„   ðŸ…   ðŸ†   ðŸ‡   ðŸˆ   ðŸ‰   ðŸŠ   ðŸ‹   ðŸŒ   ðŸ   ðŸŽ   ðŸ
U+1F75x   ðŸ   ðŸ‘   ðŸ’   ðŸ“   ðŸ”   ðŸ•   ðŸ–   ðŸ—   ðŸ˜   ðŸ™   ðŸš   ðŸ›   ðŸœ   ðŸ   ðŸž   ðŸŸ
U+1F76x   ðŸ    ðŸ¡   ðŸ¢   ðŸ£   ðŸ¤   ðŸ¥   ðŸ¦   ðŸ§   ðŸ¨   ðŸ©   ðŸª   ðŸ«   ðŸ¬   ðŸ­   ðŸ®   ðŸ¯
U+1F77x   ðŸ°   ðŸ±   ðŸ²   ðŸ³

local level = {
  "          ",
  "          ",
  "          ",
  "          ",
  "          ",
  "          ",
}


local chars = ffi.new("uint32_t[6]")
tb.tb_utf8_char_to_unicode(chars, "â–‘")
tb.tb_utf8_char_to_unicode(chars + 1, "â–’")
tb.tb_utf8_char_to_unicode(chars + 2, "â–“")
tb.tb_utf8_char_to_unicode(chars + 3, "â–ˆ")
tb.tb_utf8_char_to_unicode(chars + 4, "â–€")
tb.tb_utf8_char_to_unicode(chars + 5, "â–„")

tb.tb_init()
tb.tb_select_output_mode(tb.TB_OUTPUT_256)

local event = ffi.new("struct tb_event")
local interval = uv.new_timer()
local j = 0
interval:start(33, 33, function ()
  tb.tb_clear()
  local w, h = tb.tb_width(), tb.tb_height()
  for y = 1, h do
    for x = 1, w do
      tb.tb_change_cell(x, y, chars[((x + y) % 6)], ((x + j) % 216) + 0x10, ((y + j) % 216) + 0x10)
    end
  end

  j = (j + 1) % 216
  write(string.format("%d", uv.hrtime()), 1, 1, 0x10 + j, 0)
  for i = 1, #axes do
    local value = axes[i]
    if value < 0.01 and value > -0.01 then
      value = 0
    end
    write(string.format("Axis: %d value: %f", i, value), 1, 1 + i, value < 0 and 2 or 3, 0)
  end
  tb.tb_present()
  G.Gamepad_processEvents()
  tb.tb_peek_event(event, 13)
  if event.key == 27 and event.type == 1 then
    tb.tb_shutdown()
    interval:close()
  end
end)



